# 节约系统内存和CPU

高并发Web服务的演变

## 高并发

web变得更复杂，交互更丰富导致Web系统面对并发连接指数增长

### 页面元素增多，交互复杂

长连接（Connection keep-alive）:一经建立，这个连接会被保持住一段时间，被后续请求复用

### 主流的本浏览器的连接数在增加

## 前端优化

### 减少Web请求

HTTP 协议头的 `expire` 或 `max-age` 将静态资源放入浏览器本地缓存

HTML5 本地存储技术(LocalStorage)

### 减轻Web请求

浏览器本地缓存文件过期时，服务器资源没有更新则回复`304 Not Modified`

### 合并页面请求

- 合并HTML, CSS, JS内容
- Ajax动态内容合并请求
- 小图片合并

将多个请求变为一次批量请求，减少建立的连接，减轻web服务器压力

## 节约Web服务器内存

Web服务占用内存

- 维持连接的基本内存
- 被传输的数据内容载入缓冲区占据的内存
- 程序执行中申请和使用的内存

### prefork MPM, 多进程工作模式

- 优点：成熟稳定，兼容所有新老模块。同时，不需要担心线程安全的问题
- 缺点：一个服务进程占用很多内存

### worker MPM, 多进程和多线程混合模式

- 优点：占据更少的内存，高并发下表现更优秀
- 缺点：必须考虑线程安全的问题，同时锁的引入又增加了CPU的开销

### event MPM, 多进程和多线程混合模式，引入Epoll

### 轻量Nginx

静态文件：Nginx性能大于Apache
PHP：Nginx略逊与Apache

### sendfile节约内存

sendfile可以减少数据到“用户态内存空间”（用户缓冲区）的拷贝，进而减少内存的占用

## 节约Web服务器CPU

消耗CPU

- 业务程序的执行
- 多线程/多进程的上下文切换
- 用户连接状态的轮询和检测

### select/Poll

### Epoll

Linux2.6开始正式支持的I/O多路复用 : Epoll

### 线程/进程的创建销毁和上下文切换

Apache 一个进程/线程服务一个连接

Nginx 1个master 主进程和几个 work子进程，1个worker进程服务很多连接

### 多线程锁对CPU开销

多线程因为共享父进程的内存空间，在访问共享数据的时候，就会产生竞争，因此通常会引入锁。

程序复杂度增加，出现‘死锁’或‘饿死’的风险

