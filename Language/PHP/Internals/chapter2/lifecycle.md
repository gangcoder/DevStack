# 用户代码的执行

PHP内核的实现与世界上绝大多数的程序一样，接收输入数据， 做相应处理然后输出（返回）结果

输入PHP代码，内核对我们编写的代码进行解释和运算，返回相应的运算结果

![02-00-php-inernal.png](02-00-php-inernal.png)

## 生命周期和Zend引擎

[SAPI](../core/phpsapi.md)

### 生命周期开始和结束

#### 开始阶段

1. **第一个过程**：模块初始化阶段（MINIT），只执行一次 通过模块的MINIT回调函数，执行一些初始化工作 
1. **第二个过程**：模块激活阶段（RINIT）
1. 请求到达，PHP初始化执行脚本的基本环境(变量符号表，函数与类的符号表)

#### 结束阶段

脚本执行到末尾或者通过调用exit()或die()函数

1. 请求结束后停用模块(RSHUTDOWN，对应RINIT)
2. 在SAPI生命周期结束（Web服务器退出或者命令行脚本执行完毕退出）时关闭模块(MSHUTDOWN，对应MINIT)

### 单进程

![02-01-01-cgi-lift-cycle.png](02-01-01-cgi-lift-cycle.png)

- 初始化若干全局变量
- 初始化若干常量
- 初始化Zend引擎和核心组件
- 解析PHP.ini
- 全局操作函数的初始化
- 初始化静态构建模块和共享模块(MINIT)
- 禁用函数和类
- 激活Zend引擎
- 激活SAPI
- 环境初始化(服务器环境，请求数据环境)
- 模块请求初始化
- flush
- 关闭Zend引擎

### 多进程

Apache一般会采用多进程模式，Apache启动后会fork出多个子进程，
每个进程的内存空间独立，每个子进程都会经过开始和结束环节，
不过每个进程的开始阶段只在进程fork出来以来后进行，在整个进程的生命周期内可能会处理多个请求。

## Zend引擎

Zend引擎是PHP实现的核心，提供了语言实现上的基础设施。
例如：PHP的语法实现，脚本的编译运行环境， 扩展机制以及内存管理等

## 脚本执行

动态语言在执行时有解释器实时编译

1. 如上例中， 传递给php程序需要执行的文件， php程序完成基本的准备工作后启动PHP及Zend引擎， 加载注册的扩展模块。
1. 初始化完成后读取脚本文件，Zend引擎对脚本文件进行词法分析，语法分析。然后编译成opcode执行。 如果安装了apc之类的opcode缓存，编译环节可能会被跳过而直接从缓存中读取opcode执行。

### 词法分析

编程语言的编译器(compiler)或解释器(interpreter)一般包括两大部分：

1. 读取源程序，并处理语言结构。
1. 处理语言结构并生成目标程序。

Lex和Yacc，用于读取源程序处理语言结构，可以分为两个部分：

1. 将代码切分为一个个的标记(token)
1. 处理程序的层级结构(hierarchical structure)

Lex(词法分析生成器:A Lexical Analyzer Generator)

Yacc(Yet Another Compiler-Compiler)

### 语法分析

Lemon语法分析器

### opcode

opcode: 字节码(byte codes)，是Zend虚拟机中的指令

#### opcode_handler_t 函数处理指针查找

1. Debug
2. 计算
3. 命名查找
4. 日志记录